define("dojo/_base/declare dojo/_base/lang dojo/_base/html dojo/on ./Utils ./d3 esri/layers/FeatureLayer esri/Color esri/symbols/SimpleLineSymbol esri/symbols/SimpleMarkerSymbol esri/renderers/SimpleRenderer esri/graphic dojo/_base/array esri/InfoTemplate esri/geometry/Point esri/geometry/webMercatorUtils dijit/form/DateTextBox dijit/form/ComboBox dojo/store/Memory dijit/form/FilteringSelect dijit/form/CheckBox dijit/form/TextBox dijit/form/Button dijit/_WidgetsInTemplateMixin jimu/BaseWidget jimu/LayerInfos/LayerInfos esri/dijit/Legend".split(" "),
function(w,d,x,g,n,y,p,h,k,q,r,t,m,z,l,u,H,I,A,B,J,C,v,D,E,F,G){return w([E,D],{name:"Legend",baseClass:"jimu-widget-legend",legend:null,_jimuLayerInfos:null,startup:function(){this.inherited(arguments);permitNumberSearch=!1;json1=json_Open=json_PublicComment=json_Decision=json_Process=null;var a=document.createElement("div");a.innerHTML='<div id="queryResults"></div>';this.domNode.parentNode.insertBefore(a,this.domNode.nextSibling);featureLayer=featureLayerQuery=null;a=new h([255,153,0,.5]);a=new q("solid",
25,new k(k.STYLE_SOLID,new h([89,95,35]),1),a);a=new r(a);var c=new h([255,255,0,.25]);c=new q("solid",25,new k(k.STYLE_SOLID,new h([89,95,35]),1),c);c=new r(c);var b=new z("Permit ${RecordNumber}","<b>Address:</b> ${Address}<br> <b>Parcel Number:</b> ${ParcelNumber}<br> <b>Status:</b> ${Status}<br> <b>Description:</b> ${Description}<br> <b>Notice Date:</b> ${NoticeDate}<br> <b>Public Comment Date:</b> ${PublicCommentDate}<br> <b>Appeal End Date:</b> ${AppealEndDate}<br> <b>Decision Date:</b> ${DecisionDate}<br> <a target='_blank' href='${Link}' >More information</a><br> <a target='_blank' href='https://wspdsmap.cityoftacoma.org/website/Google/StreetView/?lat=${Latitude}&lon=${Longitude}' >Street View</a>"),
f={layerDefinition:{geometryType:"esriGeometryPoint",objectIdField:"ObjectID",fields:[]},featureSet:{features:[],geometryType:"esriGeometryPoint"}};featureLayer=new p(f,{infoTemplate:b});featureLayer.title="Land Use Permits";featureLayer.setRenderer(a);featureLayerQuery=new p(f,{infoTemplate:b});featureLayerQuery.title="Land Use Permits (filtered)";featureLayerQuery.setRenderer(c);this.map.addLayers([featureLayer]);this.map.addLayers([featureLayerQuery]);a="data/LandUseNotices.json?v=x"+(new Date).getDate();
this._download_D3(a);this._extentWatch();this.map.setLevel(this.map.getLevel());a=new A({data:[{name:"All",id:"All"},{name:"Final",id:"Decision"},{name:"Open for Appeal",id:"Open"},{name:"Permit in Process",id:"Process"},{name:"Public Comment",id:"PublicComment"}]});(new B({value:"All",store:a,style:"width: 160px;",onChange:d.hitch(this,this._queryCategory)},"categorySelect")).startup();(new v({showLabel:!1,label:"Find Category",iconClass:"dijitEditorIconSpace",onClick:d.hitch(this,this._queryCategory)},
"buttonCategory")).startup();(new C({placeHolder:"LU18-0079 etc.",style:"width: 160px;",onKeyDown:d.hitch(this,this._searchPermit)},"PermitNum")).startup();(new v({showLabel:!1,label:"Find Permit Number",iconClass:"dijitEditorIconSpace",onClick:d.hitch(this,this._searchPermit)},"buttonPermitNum")).startup();dojo.style("buttonCategory","height","20px");dojo.style("buttonCategory","width","18px");dojo.style("buttonCategory","background-image","url(images/dataSearchIcon.png)");dojo.style("buttonPermitNum",
"height","20px");dojo.style("buttonPermitNum","width","18px");dojo.style("buttonPermitNum","background-image","url(images/dataSearchIcon.png)");this._updateAllPermits()},onOpen:function(){this._jimuLayerInfos=F.getInstanceSync();var a={arrangement:this.config.legend.arrangement,autoUpdate:this.config.legend.autoUpdate,respectCurrentMapScale:this.config.legend.respectCurrentMapScale,map:this.map,layerInfos:this._getLayerInfosParam()};this.legend=new G(a,x.create("div",{},this.domNode));this.legend.startup();
this._bindEvent()},onClose:function(){this.legend.destroy()},_download_D3:function(a){y.json(a,this._filter_D3)},_filter_D3:function(a){a=a.result.records;var c=a.filter(function(a){return 0>a.Longitude&&0<a.Latitude&&""<a.Status});a.length!=c.length&&console.error(" WARNING: "+c.length+" of "+a.length+" used.  Missing records have invalid latitude/longitude or no Status value. No Status records appear in the CivicData table, but don't need to be shown on map.");this.json1=c},_requestLayerQuery:function(a,
c){var b=JSON.parse('{"items":'+JSON.stringify(c)+"}"),f=[],e="<b>"+b.items.length+"</b> selected permits in map extent.";1==b.items.length&&(e=1==permitNumberSearch?"Selected by permit number = "+b.items[0].RecordNumber:"One selected permit in map extent.");1<b.items.length&&(e+="<br>&nbsp;<br><i><b>NOTE:</b> Multiple permits may occur at one location.  Click marker for permit number and 'Browse Features' for individual permit details.</i>");m.forEach(b.items,function(a){var b={};b.RecordNumber=
a.RecordNumber;b.Address=a.Address;b.ParcelNumber=a.ParcelNumber;b.Status=a.Status;b.Description=a.Description;b.NoticeDate=a.NoticeDate;b.PublicCommentDate=a.PublicCommentDate;b.AppealEndDate=a.AppealEndDate;b.DecisionDate=a.DecisionDate;b.Link=a.Link;b.Longitude=a.Longitude;b.Latitude=a.Latitude;var c=new l({x:a.Longitude,y:a.Latitude,spatialReference:{wkid:4326}});c=new t(c);c.setAttributes(b);f.push(c);e+="<hr color='#acb1db'><br>";e+="<b>Permit: </b>"+a.RecordNumber+"<br>";e+="<b>Address: </b>"+
a.Address+"<br>";e+="<b>Parcel Number: </b>"+a.ParcelNumber+"<br>";e+="<b>Status: </b>"+a.Status+"<br>";e+="<b>Description: </b>"+a.Description+"<br>";null!==a.NoticeDate&&""!==a.NoticeDate&&(e+="<b>Notice Date: </b>"+a.NoticeDate+"<br>");null!==a.PublicCommentDate&&""!==a.PublicCommentDate&&(e+="<b>Public Comment Date: </b>"+a.PublicCommentDate+"<br>");null!==a.AppealEndDate&&""!==a.AppealEndDate&&(e+="<b>Appeal End Date: </b>"+a.AppealEndDate+"<br>");null!==a.DecisionDate&&""!==a.DecisionDate&&
(e+="<b>Decision Date: </b>"+a.DecisionDate+"<br>");e+="<b><a target='_blank' href='"+a.Link+"' >More information</a></b><br>";0>a.Longitude&&0<a.Latitude&&(e+="<b><a href='https://wspdsmap.cityoftacoma.org/website/Google/StreetView/?lat="+a.Latitude+"&lon="+a.Longitude+"' target='_blank'>Street View</a></b><br>",e+="<b><a href='javascript:void(0);'  id='"+a.RecordNumber+"' >Zoom to</a></b><br>&nbsp;<br>")});featureLayerQuery.clear();featureLayerQuery.applyEdits(f,null,null);1==f.length&&featureLayerQuery.disableFeatureReduction();
600<screen.width&&1<f.length&&(featureLayerQuery.enableFeatureReduction(),featureLayerQuery.setFeatureReduction({type:"cluster"}));featureLayer.setVisibility(!1);featureLayerQuery.setVisibility(!0);featureLayerQuery.refresh();document.getElementById("queryResults").innerHTML=e;m.forEach(b.items,function(b){var c=new l({x:b.Longitude,y:b.Latitude,spatialReference:{wkid:4326}});g(document.getElementById(""+b.RecordNumber),"click",function(){a.centerAndZoom(esri.geometry.geographicToWebMercator(new esri.geometry.Point(c)),
19)})})},_extentWatch:function(){this.own(g(this.map,"extent-change",d.hitch(this,this._extentWait)))},_extentWait:function(){this.sumTimer&&(clearTimeout(this.sumTimer),this.sumTimer=null);this.sumTimer=setTimeout(d.hitch(this,this._extentQuery),900)},_extentQuery:function(){if(!permitNumberSearch){var a=this.map.extent,c=u.xyToLngLat(a.xmin,a.ymin);a=u.xyToLngLat(a.xmax,a.ymax);this.json_Open=this.json_PublicComment=this.json_Decision=this.json_Process=null;d.hitch(this,this._queryPermits(c,a));
var b=setInterval(d.hitch(this,function(){if("All"==document.getElementById("categorySelect").value)clearInterval(b);else if(null!=this.json_Open&&null!=this.json_PublicComment&&null!=this.json_Decision&&null!=this.json_Process){clearInterval(b);var a="Public Comment"==document.getElementById("categorySelect").value?this.json_PublicComment:"Final"==document.getElementById("categorySelect").value?this.json_Decision:"Open for Appeal"==document.getElementById("categorySelect").value?this.json_Open:this.json_Process;
d.hitch(this,this._requestLayerQuery(this.map,a))}},100))}},_queryCategory:function(){1==permitNumberSearch&&(permitNumberSearch=!1,this.map.setLevel(this.map.getLevel()-1));"All"===dijit.byId("categorySelect").get("value")?(featureLayer.setVisibility(!0),featureLayerQuery.setVisibility(!1),document.getElementById("queryResults").innerHTML=""):"PublicComment"===dijit.byId("categorySelect").get("value")?d.hitch(this,this._requestLayerQuery(this.map,this.json_PublicComment)):"Decision"===dijit.byId("categorySelect").get("value")?
d.hitch(this,this._requestLayerQuery(this.map,this.json_Decision)):"Open"===dijit.byId("categorySelect").get("value")?d.hitch(this,this._requestLayerQuery(this.map,this.json_Open)):d.hitch(this,this._requestLayerQuery(this.map,this.json_Process))},_queryPermits:function(a,c){this.json_PublicComment=json_PublicComment_tmp=json1.filter(function(b){return b.Longitude>a["0"]&&b.Longitude<c["0"]&&b.Latitude>a["1"]&&b.Latitude<c["1"]&&("Public Comment"==b.Status||"Public Comment Period"==b.Status)});this.json_Open=
json_Open_tmp=json1.filter(function(b){return b.Longitude>a["0"]&&b.Longitude<c["0"]&&b.Latitude>a["1"]&&b.Latitude<c["1"]&&"Open For Appeal"==b.Status});this.json_Decision=json_Decision_tmp=json1.filter(function(b){return b.Longitude>a["0"]&&b.Longitude<c["0"]&&b.Latitude>a["1"]&&b.Latitude<c["1"]&&"Final"==b.Status});this.json_Process=json_Process_tmp=json1.filter(function(b){return b.Longitude>a["0"]&&b.Longitude<c["0"]&&b.Latitude>a["1"]&&b.Latitude<c["1"]&&"Permit in Process"==b.Status})},_updateAllPermits:function(){var a=
setInterval(function(){if(null!=json1){clearInterval(a);response=JSON.parse('{"items":'+JSON.stringify(json1)+"}");var b=[];m.forEach(response.items,function(a){var c={};c.RecordNumber=a.RecordNumber;c.Address=a.Address;c.ParcelNumber=a.ParcelNumber;c.Status=a.Status;c.Description=a.Description;c.NoticeDate=a.NoticeDate;c.PublicCommentDate=a.PublicCommentDate;c.AppealEndDate=a.AppealEndDate;c.DecisionDate=a.DecisionDate;c.Link=a.Link;c.Longitude=a.Longitude;c.Latitude=a.Latitude;a=new l({x:a.Longitude,
y:a.Latitude,spatialReference:{wkid:4326}});a=new t(a);a.setAttributes(c);b.push(a)});featureLayer.applyEdits(b,null,null);600<screen.width&&featureLayer.setFeatureReduction({type:"cluster"});featureLayer.setVisibility(!1)}},100),c=setInterval(d.hitch(this,function(){null!=this.json_PublicComment&&(clearInterval(c),dijit.byId("categorySelect").set("value","PublicComment"))},100))},_searchPermit:function(a){if(13==a.keyCode||0==a.buttons)permitNumberSearch=!0,json_PermitNumber=json1.filter(function(a){return a.RecordNumber==
document.getElementById("PermitNum").value.trim().toUpperCase()}),json_PermitNumber.length?(a=new l({x:json_PermitNumber[0].Longitude,y:json_PermitNumber[0].Latitude,spatialReference:{wkid:4326}}),this.map.centerAndZoom(a,18),d.hitch(this,this._requestLayerQuery(this.map,json_PermitNumber))):alert("Permit number "+document.getElementById("PermitNum").value.trim()+" not found.")},_bindEvent:function(){this.config.legend.autoUpdate&&(this.own(g(this._jimuLayerInfos,"layerInfosIsShowInMapChanged",d.hitch(this,
"refreshLegend"))),this.own(g(this._jimuLayerInfos,"layerInfosChanged",d.hitch(this,"refreshLegend"))),this.own(g(this._jimuLayerInfos,"layerInfosRendererChanged",d.hitch(this,"refreshLegend"))))},_getLayerInfosParam:function(){return void 0===this.config.legend.layerInfos?n.getLayerInfosParam():n.getLayerInfosParamByConfig(this.config.legend)},refreshLegend:function(){var a=this._getLayerInfosParam();this.legend.refresh(a)}})});